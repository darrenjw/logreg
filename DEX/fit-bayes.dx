'# RWMH using Dex

import plot

dat = unsafe_io do read_file "../pima.data"
dat

'# Not obvious how to parse numerical data out of the string... Plan B:


'# ************ Paste in data here !   :-(   *****************

y = [ 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 1.0 ]

x = [ [ 1.0, 5.0, 86.0, 68.0, 28.0, 30.2, 0.364, 24.0 ],
[ 1.0, 7.0, 195.0, 70.0, 33.0, 25.1, 0.163, 55.0 ],
[ 1.0, 5.0, 77.0, 82.0, 41.0, 35.8, 0.156, 35.0 ],
[ 1.0, 0.0, 165.0, 76.0, 43.0, 47.9, 0.259, 26.0 ],
[ 1.0, 0.0, 107.0, 60.0, 25.0, 26.4, 0.133, 23.0 ],
[ 1.0, 5.0, 97.0, 76.0, 27.0, 35.6, 0.378, 52.0 ],
[ 1.0, 3.0, 83.0, 58.0, 31.0, 34.3, 0.336, 25.0 ],
[ 1.0, 1.0, 193.0, 50.0, 16.0, 25.9, 0.655, 24.0 ],
[ 1.0, 3.0, 142.0, 80.0, 15.0, 32.4, 0.2, 63.0 ],
[ 1.0, 2.0, 128.0, 78.0, 37.0, 43.3, 1.224, 31.0 ],
[ 1.0, 0.0, 137.0, 40.0, 35.0, 43.1, 2.288, 33.0 ],
[ 1.0, 9.0, 154.0, 78.0, 30.0, 30.9, 0.164, 45.0 ],
[ 1.0, 1.0, 189.0, 60.0, 23.0, 30.1, 0.398, 59.0 ],
[ 1.0, 12.0, 92.0, 62.0, 7.0, 27.6, 0.926, 44.0 ],
[ 1.0, 1.0, 86.0, 66.0, 52.0, 41.3, 0.917, 29.0 ],
[ 1.0, 4.0, 99.0, 76.0, 15.0, 23.2, 0.223, 21.0 ],
[ 1.0, 1.0, 109.0, 60.0, 8.0, 25.4, 0.947, 21.0 ],
[ 1.0, 11.0, 143.0, 94.0, 33.0, 36.6, 0.254, 51.0 ],
[ 1.0, 1.0, 149.0, 68.0, 29.0, 29.3, 0.349, 42.0 ],
[ 1.0, 0.0, 139.0, 62.0, 17.0, 22.1, 0.207, 21.0 ],
[ 1.0, 2.0, 99.0, 70.0, 16.0, 20.4, 0.235, 27.0 ],
[ 1.0, 1.0, 100.0, 66.0, 29.0, 32.0, 0.444, 42.0 ],
[ 1.0, 4.0, 83.0, 86.0, 19.0, 29.3, 0.317, 34.0 ],
[ 1.0, 0.0, 101.0, 64.0, 17.0, 21.0, 0.252, 21.0 ],
[ 1.0, 1.0, 87.0, 68.0, 34.0, 37.6, 0.401, 24.0 ],
[ 1.0, 9.0, 164.0, 84.0, 21.0, 30.8, 0.831, 32.0 ],
[ 1.0, 1.0, 99.0, 58.0, 10.0, 25.4, 0.551, 21.0 ],
[ 1.0, 0.0, 140.0, 65.0, 26.0, 42.6, 0.431, 24.0 ],
[ 1.0, 5.0, 108.0, 72.0, 43.0, 36.1, 0.263, 33.0 ],
[ 1.0, 2.0, 110.0, 74.0, 29.0, 32.4, 0.698, 27.0 ],
[ 1.0, 1.0, 79.0, 60.0, 42.0, 43.5, 0.678, 23.0 ],
[ 1.0, 3.0, 148.0, 66.0, 25.0, 32.5, 0.256, 22.0 ],
[ 1.0, 0.0, 121.0, 66.0, 30.0, 34.3, 0.203, 33.0 ],
[ 1.0, 3.0, 158.0, 64.0, 13.0, 31.2, 0.295, 24.0 ],
[ 1.0, 2.0, 105.0, 80.0, 45.0, 33.7, 0.711, 29.0 ],
[ 1.0, 13.0, 145.0, 82.0, 19.0, 22.2, 0.245, 57.0 ],
[ 1.0, 1.0, 79.0, 80.0, 25.0, 25.4, 0.583, 22.0 ],
[ 1.0, 1.0, 71.0, 48.0, 18.0, 20.4, 0.323, 22.0 ],
[ 1.0, 0.0, 102.0, 86.0, 17.0, 29.3, 0.695, 27.0 ],
[ 1.0, 0.0, 119.0, 66.0, 27.0, 38.8, 0.259, 22.0 ],
[ 1.0, 8.0, 176.0, 90.0, 34.0, 33.7, 0.467, 58.0 ],
[ 1.0, 1.0, 97.0, 68.0, 21.0, 27.2, 1.095, 22.0 ],
[ 1.0, 4.0, 129.0, 60.0, 12.0, 27.5, 0.527, 31.0 ],
[ 1.0, 1.0, 97.0, 64.0, 19.0, 18.2, 0.299, 21.0 ],
[ 1.0, 0.0, 86.0, 68.0, 32.0, 35.8, 0.238, 25.0 ],
[ 1.0, 2.0, 125.0, 60.0, 20.0, 33.8, 0.088, 31.0 ],
[ 1.0, 5.0, 123.0, 74.0, 40.0, 34.1, 0.269, 28.0 ],
[ 1.0, 2.0, 92.0, 76.0, 20.0, 24.2, 1.698, 28.0 ],
[ 1.0, 3.0, 171.0, 72.0, 33.0, 33.3, 0.199, 24.0 ],
[ 1.0, 1.0, 199.0, 76.0, 43.0, 42.9, 1.394, 22.0 ],
[ 1.0, 3.0, 116.0, 74.0, 15.0, 26.3, 0.107, 24.0 ],
[ 1.0, 2.0, 83.0, 66.0, 23.0, 32.2, 0.497, 22.0 ],
[ 1.0, 8.0, 154.0, 78.0, 32.0, 32.4, 0.443, 45.0 ],
[ 1.0, 1.0, 114.0, 66.0, 36.0, 38.1, 0.289, 21.0 ],
[ 1.0, 1.0, 106.0, 70.0, 28.0, 34.2, 0.142, 22.0 ],
[ 1.0, 4.0, 127.0, 88.0, 11.0, 34.5, 0.598, 28.0 ],
[ 1.0, 1.0, 124.0, 74.0, 36.0, 27.8, 0.1, 30.0 ],
[ 1.0, 1.0, 109.0, 38.0, 18.0, 23.1, 0.407, 26.0 ],
[ 1.0, 2.0, 123.0, 48.0, 32.0, 42.1, 0.52, 26.0 ],
[ 1.0, 8.0, 167.0, 106.0, 46.0, 37.6, 0.165, 43.0 ],
[ 1.0, 7.0, 184.0, 84.0, 33.0, 35.5, 0.355, 41.0 ],
[ 1.0, 1.0, 96.0, 64.0, 27.0, 33.2, 0.289, 21.0 ],
[ 1.0, 10.0, 129.0, 76.0, 28.0, 35.9, 0.28, 39.0 ],
[ 1.0, 6.0, 92.0, 62.0, 32.0, 32.0, 0.085, 46.0 ],
[ 1.0, 6.0, 109.0, 60.0, 27.0, 25.0, 0.206, 27.0 ],
[ 1.0, 5.0, 139.0, 80.0, 35.0, 31.6, 0.361, 25.0 ],
[ 1.0, 6.0, 134.0, 70.0, 23.0, 35.4, 0.542, 29.0 ],
[ 1.0, 3.0, 106.0, 54.0, 21.0, 30.9, 0.292, 24.0 ],
[ 1.0, 0.0, 131.0, 66.0, 40.0, 34.3, 0.196, 22.0 ],
[ 1.0, 0.0, 135.0, 94.0, 46.0, 40.6, 0.284, 26.0 ],
[ 1.0, 5.0, 158.0, 84.0, 41.0, 39.4, 0.395, 29.0 ],
[ 1.0, 3.0, 112.0, 74.0, 30.0, 31.6, 0.197, 25.0 ],
[ 1.0, 8.0, 181.0, 68.0, 36.0, 30.1, 0.615, 60.0 ],
[ 1.0, 2.0, 121.0, 70.0, 32.0, 39.1, 0.886, 23.0 ],
[ 1.0, 1.0, 168.0, 88.0, 29.0, 35.0, 0.905, 52.0 ],
[ 1.0, 1.0, 144.0, 82.0, 46.0, 46.1, 0.335, 46.0 ],
[ 1.0, 2.0, 101.0, 58.0, 17.0, 24.2, 0.614, 23.0 ],
[ 1.0, 2.0, 96.0, 68.0, 13.0, 21.1, 0.647, 26.0 ],
[ 1.0, 3.0, 107.0, 62.0, 13.0, 22.9, 0.678, 23.0 ],
[ 1.0, 12.0, 121.0, 78.0, 17.0, 26.5, 0.259, 62.0 ],
[ 1.0, 2.0, 100.0, 64.0, 23.0, 29.7, 0.368, 21.0 ],
[ 1.0, 4.0, 154.0, 72.0, 29.0, 31.3, 0.338, 37.0 ],
[ 1.0, 6.0, 125.0, 78.0, 31.0, 27.6, 0.565, 49.0 ],
[ 1.0, 10.0, 125.0, 70.0, 26.0, 31.1, 0.205, 41.0 ],
[ 1.0, 2.0, 122.0, 76.0, 27.0, 35.9, 0.483, 26.0 ],
[ 1.0, 2.0, 114.0, 68.0, 22.0, 28.7, 0.092, 25.0 ],
[ 1.0, 1.0, 115.0, 70.0, 30.0, 34.6, 0.529, 32.0 ],
[ 1.0, 7.0, 114.0, 76.0, 17.0, 23.8, 0.466, 31.0 ],
[ 1.0, 2.0, 115.0, 64.0, 22.0, 30.8, 0.421, 21.0 ],
[ 1.0, 1.0, 130.0, 60.0, 23.0, 28.6, 0.692, 21.0 ],
[ 1.0, 1.0, 79.0, 75.0, 30.0, 32.0, 0.396, 22.0 ],
[ 1.0, 4.0, 112.0, 78.0, 40.0, 39.4, 0.236, 38.0 ],
[ 1.0, 7.0, 150.0, 78.0, 29.0, 35.2, 0.692, 54.0 ],
[ 1.0, 1.0, 91.0, 54.0, 25.0, 25.2, 0.234, 23.0 ],
[ 1.0, 1.0, 100.0, 72.0, 12.0, 25.3, 0.658, 28.0 ],
[ 1.0, 12.0, 140.0, 82.0, 43.0, 39.2, 0.528, 58.0 ],
[ 1.0, 4.0, 110.0, 76.0, 20.0, 28.4, 0.118, 27.0 ],
[ 1.0, 2.0, 94.0, 76.0, 18.0, 31.6, 0.649, 23.0 ],
[ 1.0, 2.0, 84.0, 50.0, 23.0, 30.4, 0.968, 21.0 ],
[ 1.0, 10.0, 148.0, 84.0, 48.0, 37.6, 1.001, 51.0 ],
[ 1.0, 3.0, 61.0, 82.0, 28.0, 34.4, 0.243, 46.0 ],
[ 1.0, 4.0, 117.0, 62.0, 12.0, 29.7, 0.38, 30.0 ],
[ 1.0, 3.0, 99.0, 80.0, 11.0, 19.3, 0.284, 30.0 ],
[ 1.0, 3.0, 80.0, 82.0, 31.0, 34.2, 1.292, 27.0 ],
[ 1.0, 4.0, 154.0, 62.0, 31.0, 32.8, 0.237, 23.0 ],
[ 1.0, 6.0, 103.0, 72.0, 32.0, 37.7, 0.324, 55.0 ],
[ 1.0, 6.0, 111.0, 64.0, 39.0, 34.2, 0.26, 24.0 ],
[ 1.0, 0.0, 124.0, 70.0, 20.0, 27.4, 0.254, 36.0 ],
[ 1.0, 1.0, 143.0, 74.0, 22.0, 26.2, 0.256, 21.0 ],
[ 1.0, 1.0, 81.0, 74.0, 41.0, 46.3, 1.096, 32.0 ],
[ 1.0, 4.0, 189.0, 110.0, 31.0, 28.5, 0.68, 37.0 ],
[ 1.0, 4.0, 116.0, 72.0, 12.0, 22.1, 0.463, 37.0 ],
[ 1.0, 7.0, 103.0, 66.0, 32.0, 39.1, 0.344, 31.0 ],
[ 1.0, 8.0, 124.0, 76.0, 24.0, 28.7, 0.687, 52.0 ],
[ 1.0, 1.0, 71.0, 78.0, 50.0, 33.2, 0.422, 21.0 ],
[ 1.0, 0.0, 137.0, 84.0, 27.0, 27.3, 0.231, 59.0 ],
[ 1.0, 9.0, 112.0, 82.0, 32.0, 34.2, 0.26, 36.0 ],
[ 1.0, 4.0, 148.0, 60.0, 27.0, 30.9, 0.15, 29.0 ],
[ 1.0, 1.0, 136.0, 74.0, 50.0, 37.4, 0.399, 24.0 ],
[ 1.0, 9.0, 145.0, 80.0, 46.0, 37.9, 0.637, 40.0 ],
[ 1.0, 1.0, 93.0, 56.0, 11.0, 22.5, 0.417, 22.0 ],
[ 1.0, 1.0, 107.0, 72.0, 30.0, 30.8, 0.821, 24.0 ],
[ 1.0, 12.0, 151.0, 70.0, 40.0, 41.8, 0.742, 38.0 ],
[ 1.0, 1.0, 97.0, 70.0, 40.0, 38.1, 0.218, 30.0 ],
[ 1.0, 5.0, 144.0, 82.0, 26.0, 32.0, 0.452, 58.0 ],
[ 1.0, 2.0, 112.0, 86.0, 42.0, 38.4, 0.246, 28.0 ],
[ 1.0, 2.0, 99.0, 52.0, 15.0, 24.6, 0.637, 21.0 ],
[ 1.0, 1.0, 109.0, 56.0, 21.0, 25.2, 0.833, 23.0 ],
[ 1.0, 1.0, 120.0, 80.0, 48.0, 38.9, 1.162, 41.0 ],
[ 1.0, 7.0, 187.0, 68.0, 39.0, 37.7, 0.254, 41.0 ],
[ 1.0, 3.0, 129.0, 92.0, 49.0, 36.4, 0.968, 32.0 ],
[ 1.0, 7.0, 179.0, 95.0, 31.0, 34.2, 0.164, 60.0 ],
[ 1.0, 6.0, 80.0, 66.0, 30.0, 26.2, 0.313, 41.0 ],
[ 1.0, 2.0, 105.0, 58.0, 40.0, 34.9, 0.225, 25.0 ],
[ 1.0, 3.0, 191.0, 68.0, 15.0, 30.9, 0.299, 34.0 ],
[ 1.0, 0.0, 95.0, 80.0, 45.0, 36.5, 0.33, 26.0 ],
[ 1.0, 4.0, 99.0, 72.0, 17.0, 25.6, 0.294, 28.0 ],
[ 1.0, 0.0, 137.0, 68.0, 14.0, 24.8, 0.143, 21.0 ],
[ 1.0, 1.0, 97.0, 70.0, 15.0, 18.2, 0.147, 21.0 ],
[ 1.0, 0.0, 100.0, 88.0, 60.0, 46.8, 0.962, 31.0 ],
[ 1.0, 1.0, 167.0, 74.0, 17.0, 23.4, 0.447, 33.0 ],
[ 1.0, 0.0, 180.0, 90.0, 26.0, 36.5, 0.314, 35.0 ],
[ 1.0, 2.0, 122.0, 70.0, 27.0, 36.8, 0.34, 27.0 ],
[ 1.0, 1.0, 90.0, 62.0, 12.0, 27.2, 0.58, 24.0 ],
[ 1.0, 3.0, 120.0, 70.0, 30.0, 42.9, 0.452, 30.0 ],
[ 1.0, 6.0, 154.0, 78.0, 41.0, 46.1, 0.571, 27.0 ],
[ 1.0, 2.0, 56.0, 56.0, 28.0, 24.2, 0.332, 22.0 ],
[ 1.0, 0.0, 177.0, 60.0, 29.0, 34.6, 1.072, 21.0 ],
[ 1.0, 3.0, 124.0, 80.0, 33.0, 33.2, 0.305, 26.0 ],
[ 1.0, 8.0, 85.0, 55.0, 20.0, 24.4, 0.136, 42.0 ],
[ 1.0, 12.0, 88.0, 74.0, 40.0, 35.3, 0.378, 48.0 ],
[ 1.0, 9.0, 152.0, 78.0, 34.0, 34.2, 0.893, 33.0 ],
[ 1.0, 0.0, 198.0, 66.0, 32.0, 41.3, 0.502, 28.0 ],
[ 1.0, 0.0, 188.0, 82.0, 14.0, 32.0, 0.682, 22.0 ],
[ 1.0, 5.0, 139.0, 64.0, 35.0, 28.6, 0.411, 26.0 ],
[ 1.0, 7.0, 168.0, 88.0, 42.0, 38.2, 0.787, 40.0 ],
[ 1.0, 2.0, 197.0, 70.0, 99.0, 34.7, 0.575, 62.0 ],
[ 1.0, 2.0, 142.0, 82.0, 18.0, 24.7, 0.761, 21.0 ],
[ 1.0, 8.0, 126.0, 74.0, 38.0, 25.9, 0.162, 39.0 ],
[ 1.0, 3.0, 158.0, 76.0, 36.0, 31.6, 0.851, 28.0 ],
[ 1.0, 3.0, 130.0, 78.0, 23.0, 28.4, 0.323, 34.0 ],
[ 1.0, 2.0, 100.0, 54.0, 28.0, 37.8, 0.498, 24.0 ],
[ 1.0, 1.0, 164.0, 82.0, 43.0, 32.8, 0.341, 50.0 ],
[ 1.0, 4.0, 95.0, 60.0, 32.0, 35.4, 0.284, 28.0 ],
[ 1.0, 2.0, 122.0, 52.0, 43.0, 36.2, 0.816, 28.0 ],
[ 1.0, 4.0, 85.0, 58.0, 22.0, 27.8, 0.306, 28.0 ],
[ 1.0, 0.0, 151.0, 90.0, 46.0, 42.1, 0.371, 21.0 ],
[ 1.0, 6.0, 144.0, 72.0, 27.0, 33.9, 0.255, 40.0 ],
[ 1.0, 3.0, 111.0, 90.0, 12.0, 28.4, 0.495, 29.0 ],
[ 1.0, 1.0, 107.0, 68.0, 19.0, 26.5, 0.165, 24.0 ],
[ 1.0, 6.0, 115.0, 60.0, 39.0, 33.7, 0.245, 40.0 ],
[ 1.0, 5.0, 105.0, 72.0, 29.0, 36.9, 0.159, 28.0 ],
[ 1.0, 7.0, 194.0, 68.0, 28.0, 35.9, 0.745, 41.0 ],
[ 1.0, 4.0, 184.0, 78.0, 39.0, 37.0, 0.264, 31.0 ],
[ 1.0, 0.0, 95.0, 85.0, 25.0, 37.4, 0.247, 24.0 ],
[ 1.0, 7.0, 124.0, 70.0, 33.0, 25.5, 0.161, 37.0 ],
[ 1.0, 1.0, 111.0, 62.0, 13.0, 24.0, 0.138, 23.0 ],
[ 1.0, 7.0, 137.0, 90.0, 41.0, 32.0, 0.391, 39.0 ],
[ 1.0, 9.0, 57.0, 80.0, 37.0, 32.8, 0.096, 41.0 ],
[ 1.0, 2.0, 157.0, 74.0, 35.0, 39.4, 0.134, 30.0 ],
[ 1.0, 2.0, 95.0, 54.0, 14.0, 26.1, 0.748, 22.0 ],
[ 1.0, 12.0, 140.0, 85.0, 33.0, 37.4, 0.244, 41.0 ],
[ 1.0, 0.0, 117.0, 66.0, 31.0, 30.8, 0.493, 22.0 ],
[ 1.0, 8.0, 100.0, 74.0, 40.0, 39.4, 0.661, 43.0 ],
[ 1.0, 9.0, 123.0, 70.0, 44.0, 33.1, 0.374, 40.0 ],
[ 1.0, 0.0, 138.0, 60.0, 35.0, 34.6, 0.534, 21.0 ],
[ 1.0, 14.0, 100.0, 78.0, 25.0, 36.6, 0.412, 46.0 ],
[ 1.0, 14.0, 175.0, 62.0, 30.0, 33.6, 0.212, 38.0 ],
[ 1.0, 0.0, 74.0, 52.0, 10.0, 27.8, 0.269, 22.0 ],
[ 1.0, 1.0, 133.0, 102.0, 28.0, 32.8, 0.234, 45.0 ],
[ 1.0, 0.0, 119.0, 64.0, 18.0, 34.9, 0.725, 23.0 ],
[ 1.0, 5.0, 155.0, 84.0, 44.0, 38.7, 0.619, 34.0 ],
[ 1.0, 1.0, 128.0, 48.0, 45.0, 40.5, 0.613, 24.0 ],
[ 1.0, 2.0, 112.0, 68.0, 22.0, 34.1, 0.315, 26.0 ],
[ 1.0, 1.0, 140.0, 74.0, 26.0, 24.1, 0.828, 23.0 ],
[ 1.0, 2.0, 141.0, 58.0, 34.0, 25.4, 0.699, 24.0 ],
[ 1.0, 7.0, 129.0, 68.0, 49.0, 38.5, 0.439, 43.0 ],
[ 1.0, 0.0, 106.0, 70.0, 37.0, 39.4, 0.605, 22.0 ],
[ 1.0, 1.0, 118.0, 58.0, 36.0, 33.3, 0.261, 23.0 ],
[ 1.0, 8.0, 155.0, 62.0, 26.0, 34.0, 0.543, 46.0 ]]

'# ***************************************************


def ll (b: (Fin 8)=>Float) : Float =
  neg $ sum (log (map (\ x. x+1) (exp (neg ((map (\ yi. 2*yi - 1) y)*(x **. b))))))

pscale = [10.0, 1, 1, 1, 1, 1, 1, 1] -- prior SDs
prscale = map (\ x. 1.0/x) pscale

def lprior (b: (Fin 8)=>Float) : Float =
  bs = b*prscale
  neg $ sum ((log pscale) + (0.5 .* (bs*bs)))

def lpost (b: (Fin 8)=>Float) : Float =
  (ll b) + (lprior b)

pre = [10.0,1,1,1,1,1,5,1] -- pre-conditioner - relative weights of proposal SDs

def rprop (k: Key) (b: (Fin 8)=>Float) : (Fin 8)=>Float =
  b + 0.02 .* (pre * (randn_vec k))

k = new_key 42

def mKernel {s} (lpost: s -> Float) (rprop: Key -> s -> s) : Key -> (s & Float) -> (s & Float) =
  def kern (k: Key) (sll: (s & Float)) : (s & Float) =
    (x0, ll0) = sll
    [k1, k2] = split_key k
    x = rprop k1 x0
    ll = lpost x
    a = ll - ll0
    u = rand k2
    select (log u < a) (x, ll) (x0, ll0)
  kern

def stepN {s} (n: Nat) (kern: Key -> s -> s) : Key -> s -> s =
  def go (k: Key) (state: s) : s =
    xv = with_state state \st.
      for i:(Fin n).
        x = kern (ixkey k i) (get st)
        st := x
        x
    head $ reverse xv
  go

kern = mKernel lpost rprop

def mcmc {s} (k: Key) (init: s) (kern: Key -> s -> s) (its: Nat) : Fin its => s =
  with_state init \st.
    for i:(Fin its).
      x = kern (ixkey k i) (get st)
      st := x
      x

init = [-9.0,0,0,0,0,0,0,0]

out = mcmc k (init, -1.0e50) (stepN 1000 kern) 10000

def meanAndCovariance {n d} (xs:n=>d=>Float) : (d=>Float & d=>d=>Float) =
   xsMean :    d=>Float = (for i. sum for j. xs.j.i) / n_to_f (size n)
   xsCov  : d=>d=>Float = (for i i'. sum for j.
                           (xs.j.i' - xsMean.i') *
                           (xs.j.i  - xsMean.i )   ) / (n_to_f (size n) - 1)
   (xsMean, xsCov)

mat = map fst out -- ditch log-posterior evaluations
mv = meanAndCovariance mat
fst mv -- mean
snd mv -- (co)variance matrix

:html show_plot $ y_plot $
  (map head mat)

-- TODO: output??

'# eof
